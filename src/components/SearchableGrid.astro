---
interface Props {
    placeholder?: string;
    noResultsText?: string;
    cardWidth?: number;
}

const { placeholder = 'Search...', noResultsText = 'No results found.', cardWidth = 160 } = Astro.props as Props;
---

<div class="searchable-grid">
    <div class="search-wrap">
        <label for="search" class="visually-hidden">Search</label>
        <input id="search" type="search" placeholder={placeholder} autofocus />
    </div>

    <div class="grid" style={`grid-template-columns: repeat(auto-fill, minmax(${cardWidth}px, 1fr));`}>
        <slot />
    </div>

    <div class="no-results" hidden>{noResultsText}</div>
</div>

<script>
    // @ts-nocheck
    const input = document.querySelector('#search');
    const grid = document.querySelector('.grid');
    const noResults = document.querySelector('.no-results');

    const items = () => Array.from(grid.querySelectorAll('.card-item'));

    function normalize(s) {
        return (s || '').toString().toLowerCase();
    }

    function matches(item, q) {
        if (!q) return true;
        const ds = item.dataset;
        const combined = Object.keys(ds)
            .map((k) => ds[k])
            .join(' ');
        return normalize(combined).includes(q);
    }

    let timeout = null;
    function onInput() {
        const q = normalize(input.value.trim());
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => {
            let anyMatched = false;
            items().forEach((item) => {
                const matched = matches(item, q);
                item.style.display = matched ? '' : 'none';
                if (matched) anyMatched = true;
            });
            if (noResults) noResults.hidden = anyMatched;
        }, 150);
    }

    input.addEventListener('input', onInput);
</script>

<style>
    .search-wrap {
        display: flex;
    }

    input[type='search'] {
        flex: 1 1 auto;
        border: var(--text) 3px solid;
        border-radius: 6px;
        background: var(--bg1);
        padding: 0.75rem;
        color: var(--text);
        accent-color: var(--accent);
        font-size: 1.25rem;
    }

    input[type='search']:focus {
        outline: none;
        border: var(--accent) 3px solid;
    }

    input[type='search']::-webkit-search-cancel-button {
        filter: invert(100%) sepia(100%) saturate(500%) hue-rotate(90deg);
        padding-left: 0.3rem;
    }

    .visually-hidden {
        position: absolute !important;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        margin: -1px;
        border: 0;
        padding: 0;
        white-space: nowrap;
    }

    .grid {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
    }

    .no-results {
        margin-top: 2rem;
        color: var(--text);
        font-size: 2rem;
        text-align: center;
    }
</style>
